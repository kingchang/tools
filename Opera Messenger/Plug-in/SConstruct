import os, SConsX


env = Environment(
    CPPDEFINES = {'PUBLIC_API': 'PUBLIC_EXPORT'},
    SHLIBPREFIX = 'np')

env.ParseConfig('pkg-config --cflags --libs purple | sed "s/-I/-isystem/g"')

files = Glob('*.cpp')
tool = env.BuildTool()[0]

if tool == 'GNU':
    env.Append(CCFLAGS = [
        '-isystem' + os.environ['NP_API_SDK_INCLUDE_PATH'],
        '-ansi',
        '-pedantic-errors',
        '-Wall',
        '-Weffc++',
        #'-Wextra',
        '-Wold-style-cast',
        '-Wredundant-decls',
        '-Wshadow',
        '-Wswitch-default',
        #'-Wundef',
        '-Wunused-macros',
    ])
else:
    env.Append(CPPPATH = [os.environ['NP_API_SDK_INCLUDE_PATH']])

if tool == 'MSVC':
    files += env.RES(Glob('*.rc'))
    env.Append(CPPDEFINES = ['_WINDOWS', '_X86_', 'WIN32'])
    env.Append(CCFLAGS = ['/EHsc', '/MD'])

[library] = env.SharedLibrary(
    target = 'Purple',
    source = files,
    LIBS = ['purple'])

if tool == 'MSVC':
    env.EmbedManifest(library)
